<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý Email Online - Auto Filter</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
    textarea, input, button { margin-top: 10px; padding: 10px; width: 90%; max-width: 400px; }
    button { cursor: pointer; }
    #copyButton { background: #28a745; color: white; font-size: 18px; }
    #deleteListButton { background: #dc3545; color: white; }
    #clearLogsButton { background: #ffc107; }
    #manualCopyButton { width: 60px; }
  </style>
</head>
<body>
  <h3>📨 Quản lý danh sách Email Online</h3>

  <textarea id="emailListInput" placeholder="Dán email, phân cách bằng dấu cách, ; , | ..."></textarea>
  <button id="addListButton">➕ Thêm Email Vào Danh Sách</button>
  <button id="deleteListButton">🗑️ Xóa Danh Sách Email</button>

  <div>
    <input type="text" id="emailOutput" placeholder="Email sẽ hiện ở đây" readonly>
    <button id="manualCopyButton">📋</button>
  </div>

  <p id="count"></p>
  <button id="clearLogsButton">🧹 Clear Log Copy</button>
  <br/>
  <button id="copyButton">📋 Lấy & Copy Email</button>

  <div id="customToast" style="margin-top:15px;color:red;font-weight:bold;"></div>

<script>
  // 👉 TODO: Dán firebaseConfig thật của bạn vào đây
  const firebaseConfig = {
  apiKey: "AIzaSyD8qx-1A6yY9HZqAe6MoN8NkinQBpM6a8",
  authDomain: "webmail-app-f8158.firebaseapp.com",
  databaseURL: "https://webmail-app-f8158-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "webmail-app-f8158",
  storageBucket: "webmail-app-f8158.firebasestorage.app",
  messagingSenderId: "788366209485",
  appId: "1:788366209485:web:7497b706433add7d11d484"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const emailRef = db.ref('emails');

  let emailList = [];

  function extractEmails(text) {
    const parts = text.split(/[\s,;|]+/);
    const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    const unique = new Set();
    parts.forEach(p => { if (regex.test(p.trim())) unique.add(p.trim().toLowerCase()); });
    return Array.from(unique);
  }

  function updateCount() {
    document.getElementById('count').textContent = `📊 Số email còn lại: ${emailList.length}`;
  }

  function showToast(msg) {
    document.getElementById('customToast').textContent = msg;
    setTimeout(() => { document.getElementById('customToast').textContent = ""; }, 3000);
  }

  function copyText(text) {
    navigator.clipboard.writeText(text).then(() => showToast("✅ Đã copy: " + text));
  }

  // Lắng nghe thay đổi dữ liệu realtime
  emailRef.on('value', snap => {
    emailList = snap.val() || [];
    updateCount();
  });

  document.getElementById('addListButton').onclick = () => {
    const input = document.getElementById('emailListInput').value.trim();
    const emails = extractEmails(input);
    if (emails.length === 0) return showToast("⚠️ Không có email hợp lệ.");
    emailRef.transaction(current => {
      const updated = current ? current.slice() : [];
      emails.forEach(e => { if (!updated.includes(e)) updated.push(e); });
      return updated;
    }, (err, committed) => {
      if (err || !committed) showToast("⚠️ Lỗi thêm email.");
      else showToast(`✅ Đã thêm ${emails.length} email.`);
      document.getElementById('emailListInput').value = '';
    });
  };

  document.getElementById('deleteListButton').onclick = () => {
    if (!confirm("Bạn có chắc muốn xóa danh sách?")) return;
    emailRef.set([], err => {
      if (err) showToast("⚠️ Lỗi xóa danh sách.");
      else showToast("✅ Đã xóa toàn bộ.");
    });
  };

  document.getElementById('manualCopyButton').onclick = () => {
    const email = document.getElementById('emailOutput').value;
    if (!email) return showToast("⚠️ Không có email để copy.");
    copyText(email);
  };

  document.getElementById('copyButton').onclick = () => {
    if (emailList.length === 0) return showToast("⚠️ Hết email.");
    const idx = Math.floor(Math.random() * emailList.length);
    const email = emailList[idx];
    document.getElementById('emailOutput').value = email;
    copyText(email);
    // Xóa email đã lấy
    emailRef.transaction(list => {
      if (!list) return [];
      const i = list.indexOf(email);
      if (i !== -1) list.splice(i, 1);
      return list;
    });
  };

  document.getElementById('clearLogsButton').onclick = () => {
    document.getElementById('emailOutput').value = "";
    showToast("✅ Đã clear log.");
  };
</script>
</body>
</html>
